# 기능 명세서 — 회원가입/로그인, 동의 관리, 캘린더(공휴일)

본 문서는 회원가입/로그인, 약관 동의 관리 및 캘린더 기능을 정리하여 **개발, QA, 기획** 등 팀 전체가 동일한 기준을 공유할 수 있도록 작성되었습니다.

**작성자:** [왕택준](https://github.com/TJK98)

**문서 버전:** v0.1

**최종 수정일:** 2025.09.10

**대상 독자:**

* 백엔드 개발자: DB 스키마, API 구현
* 프론트엔드 개발자: 화면 설계 및 연동
* QA: 검증 및 시나리오 테스트
* 기획/PM: 서비스 플로우 확인

---

## 1. 회원 관리 (User)

### 1.1 계정 모델 개요

* **식별자 분리**
  * 내부 PK: `user.id`
  * 로컬 로그인: `email` = 로그인 ID
  * 소셜 로그인(카카오): `(provider, provider_user_id)`
* **이메일**
  * 로컬 계정: 필수 (인증번호 기반 인증)
  * 소셜 계정: 선택 (NULL 허용, 온보딩 또는 마이페이지에서 등록/검증 가능)

### 1.2 회원가입 (로컬)

* **입력 항목**
  * 이메일 (유니크, 인증 필수)
  * 비밀번호 (BCrypt/Argon2 해시)
  * 닉네임 (선택)
* **처리**
  * 기본 계정 생성 후 이메일 인증
  * 인증 완료 후 로그인 → **온보딩 페이지로 리다이렉트**
  * `created_at`, `status=ACTIVE`, `onboarding_completed=0`

### 1.3 로그인 (로컬)

* **인증:** 이메일 + 비밀번호
* **처리:**
  * 비밀번호 해시 검증
  * 성공 시 `last_login_at` 갱신
  * Access/Refresh 토큰 발급 (HttpOnly + Secure 쿠키)
  * **온보딩 미완료 시 온보딩 페이지로 리다이렉트**

### 1.4 소셜 로그인 (카카오)

* **카카오 제공 정보:** `id`, `nickname` (프로필 이미지는 무시)
* **플로우:**
  1. 콜백 시 `provider_user_id`로 `social_account` 조회
  2. 없으면 기본 계정 생성 (`email=NULL`, `nickname=카카오닉네임` 또는 중복 시 자동 suffix 추가)
  3. **온보딩 페이지로 리다이렉트** → 필수/선택 동의 수집
  4. 온보딩 완료 후 홈 진입

* **닉네임 중복 처리:**

```javascript
const kakaoNickname = "홍길동";
let finalNickname = kakaoNickname;
let suffix = 1;

while (await isNicknameExists(finalNickname)) {
  finalNickname = `${kakaoNickname}${suffix}`;
  suffix++;
}
```

### 1.5 온보딩 페이지

* **대상:** 로컬/카카오 모든 신규 사용자
* **입력 항목:**
  * 서비스 약관 동의 (필수)
  * 일정 개인화 추천 동의 (필수)
  * 일기/투두/버킷 개인화 동의 (선택)
  * 생년월일 (선택)
  * 이메일 (카카오 사용자만, 선택)
* **처리:**
  * 필수 동의 모두 체크해야 완료 가능
  * 완료 시 `onboarding_completed=1`, `consent_updated_at` 갱신
  * 선택 동의는 이후 마이페이지에서 수정 가능

### 1.6 사용자 설정

* `week_start`: 주 시작 요일 (기본 MON)
* `timezone`: 기본 `Asia/Seoul`
* `show_holidays`: 공휴일 표시 여부 (기본 표시)

---

## 2. 동의 관리

### 2.1 동의 항목

* `terms_of_service_agreed` (필수) – 서비스 약관
* `calendar_personalization_agreed` (필수) – 일정 기반 추천 동의
* `diary_personalization_agreed` (선택)
* `todo_personalization_agreed` (선택)
* `bucket_personalization_agreed` (선택)
* `consent_version`, `consent_updated_at`
* `onboarding_completed` – 온보딩 완료 여부

### 2.2 수정/업데이트

* **마이페이지에서 수정 가능:**
  * 선택 동의 on/off
  * 필수 동의는 해제 불가 (표시만)
* 동의 이력은 `consent_updated_at` 기준 관리
* **선택 동의 off 시:**
  * 신규 데이터 수집 중지
  * 해당 기능 접근 시 403 + "동의 필요" → 동의 모달 표시

### 2.3 온보딩 상태 체크

* 홈 진입 시 `onboarding_completed` 확인
* 미완료 시 온보딩 페이지로 강제 리다이렉트
* 완료된 사용자는 정상 서비스 이용

---

## 3. 캘린더 — 공휴일 연동 (Holiday)

### 3.1 데이터 수집

* **소스:** 한국천문연구원 특일 정보 API
* **주기:** 연 1회 + 필요시 재수집
* **동기화:** `external_id` 기준 UPSERT

### 3.2 저장 스키마

* **컬럼:** `country_code`, `start_date`, `end_date`, `name_ko`, `is_substitute`, `source`, `external_id`, `year`, `last_synced_at`
* **제약:** `(country_code, start_date, end_date, name_ko)` 유니크

### 3.3 UI 전달

```json
{
  "id": "h-2025-10-03",
  "title": "개천절",
  "start": "2025-10-03",
  "end": "2025-10-03",
  "allDay": true,
  "type": "HOLIDAY",
  "isSubstitute": false
}
```

---

## 4. 마이페이지 (사용자 관리)

### 4.1 프로필

* **닉네임:** 카카오 로그인 시 자동 수집 → 수정 가능
* **생년월일:** 온보딩 또는 마이페이지에서 입력/수정 가능
* **이메일:**
  * 로컬 계정: 수정 불가 (로그인 ID이므로)
  * 카카오 계정: 등록/변경 → 인증메일 발송 → 인증 완료 후 `email_verified=1`

### 4.2 동의 관리

* **현재 동의 상태 조회**
* **선택 동의 토글 가능**
* **필수 동의는 표시만 가능(수정 불가)**
* 동의 변경 시 영향도 안내 표시

### 4.3 이메일 연동 정책

* **카카오 계정의 이메일은 선택사항**
* **복구/영수증 등 이메일 필요 기능 사용 시점에 이메일 등록 요구**
* **이메일 등록 시 인증 프로세스 진행**

---

## 5. API 명세

### 5.1 Auth (로컬)

* `POST /api/auth/signup` - 기본 정보만 (이메일, 비밀번호, 닉네임)
* `POST /api/auth/login`
* `POST /api/auth/logout`
* `POST /api/auth/token/refresh`
* `POST /api/auth/email/verify` - 이메일 인증

### 5.2 Auth (카카오)

* `GET /oauth2/authorization/kakao` – 카카오 로그인 시작
* `GET /login/oauth2/code/kakao` – 콜백
* `POST /api/auth/email/link` – 이메일 인증 요청 (카카오 사용자)
* `GET /api/auth/email/verify?token=...` – 이메일 검증

### 5.3 온보딩

* `GET /api/me/onboarding-status` - 온보딩 상태 확인

```json
{
  "onboardingCompleted": false,
  "requiredConsents": ["termsOfService", "calendarPersonalization"]
}
```

* `POST /api/auth/onboarding` - 온보딩 완료

```json
{
  "termsOfServiceAgreed": true,
  "calendarPersonalizationAgreed": true,
  "diaryPersonalizationAgreed": false,
  "todoPersonalizationAgreed": true,
  "bucketPersonalizationAgreed": false,
  "birthDate": "1990-01-01", // optional
  "email": "user@example.com" // 카카오 사용자만, optional
}
```

### 5.4 Profile & Consent

* `GET /api/me/profile`
* `PATCH /api/me/profile`
* `GET /api/me/consents`
* `PATCH /api/me/consents`

### 5.5 Calendar

* `GET /api/calendar`
* `GET /api/calendar/holidays`

---

## 6. DB 스키마

```sql
-- user
CREATE TABLE user (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  email VARCHAR(255) NULL,
  password_hash VARCHAR(255) NULL,
  email_verified TINYINT(1) NOT NULL DEFAULT 0,

  nickname VARCHAR(50) NULL,
  birth_date DATE NULL,

  -- 동의 관련 (필드명 개선)
  terms_of_service_agreed TINYINT(1) NOT NULL DEFAULT 0,
  calendar_personalization_agreed TINYINT(1) NOT NULL DEFAULT 0,
  diary_personalization_agreed TINYINT(1) NOT NULL DEFAULT 0,
  todo_personalization_agreed TINYINT(1) NOT NULL DEFAULT 0,
  bucket_personalization_agreed TINYINT(1) NOT NULL DEFAULT 0,
  consent_version VARCHAR(20) NOT NULL DEFAULT 'v1.0',
  consent_updated_at DATETIME NULL,

  -- 온보딩 완료 여부 추가
  onboarding_completed TINYINT(1) NOT NULL DEFAULT 0,

  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  last_login_at DATETIME NULL,
  status ENUM('ACTIVE','BLOCKED','DELETED') NOT NULL DEFAULT 'ACTIVE',

  week_start ENUM('SUN','MON') NOT NULL DEFAULT 'MON',
  timezone VARCHAR(50) NOT NULL DEFAULT 'Asia/Seoul',
  show_holidays TINYINT(1) NOT NULL DEFAULT 1,

  UNIQUE KEY uq_user_email (email),
  UNIQUE KEY uq_user_nickname (nickname)
);

-- social_account
CREATE TABLE social_account (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  user_id BIGINT NOT NULL,
  provider ENUM('KAKAO','GOOGLE','APPLE') NOT NULL,
  provider_user_id VARCHAR(255) NOT NULL,
  raw_attributes JSON NULL,
  linked_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY uq_social (provider, provider_user_id),
  CONSTRAINT fk_social_user FOREIGN KEY (user_id) REFERENCES user(id)
);

-- holiday
CREATE TABLE holiday (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  country_code CHAR(2) NOT NULL DEFAULT 'KR',
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  name_ko VARCHAR(100) NOT NULL,
  is_substitute TINYINT(1) NOT NULL DEFAULT 0,
  source VARCHAR(50) NOT NULL,
  external_id VARCHAR(100) NULL,
  year SMALLINT NOT NULL,
  last_synced_at DATETIME NOT NULL,
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uq_holiday (country_code, start_date, end_date, name_ko),
  KEY idx_holiday_year (country_code, year, start_date)
);
```

---

## 7. 에러 코드

### 7.1 인증 관련

* `AUTH-001` 잘못된 자격증명
* `AUTH-002` 차단/삭제 계정
* `AUTH-101` 소셜 응답 검증 실패
* `AUTH-102` 소셜 계정 중복 연결
* `AUTH-201` 이메일 미검증
* `AUTH-301` 온보딩 미완료
* `AUTH-302` 필수 동의 누락

### 7.2 사용자 관련

* `USER-001` 닉네임 중복
* `USER-002` 이메일 등록 필요
* `AUTH-EMAIL-CONFLICT` 이메일 중복 사용

### 7.3 캘린더 관련

* `CAL-001` 잘못된 기간 파라미터
* `CAL-101` 공휴일 동기화 실패

---

## 8. 권장 구현 순서

1. **1단계**: 로컬 회원가입/로그인 구현
2. **2단계**: 온보딩 페이지 구현 (로컬 계정용)
3. **3단계**: 카카오 로그인 + 온보딩 연동
4. **4단계**: 마이페이지 프로필/동의 관리 구현
5. **5단계**: 이메일 연동 기능 구현 (카카오 계정용)
6. **6단계**: 공휴일 API 연동

---

## 9. QA 체크리스트

### 9.1 회원가입/로그인

* 로컬 회원가입: 기본 정보 입력 → 이메일 인증 → 로그인 → 온보딩
* 카카오 로그인: OAuth 성공 → 계정 생성/조회 → 온보딩
* 닉네임 중복 시 자동 suffix 추가 확인

### 9.2 온보딩

* 필수 동의 미체크 시 완료 불가
* 온보딩 미완료 시 홈 접근 차단
* 카카오 사용자 이메일 선택 입력 가능

### 9.3 마이페이지

* 닉네임/생년월일 수정 가능
* 선택 동의 on/off 토글 확인
* 로컬 계정 이메일 수정 불가, 카카오 계정 이메일 등록/수정 가능

### 9.4 기능 접근 제한

* 선택 동의 off 시 해당 기능 접근 시 403 + 동의 모달
* 이메일 필요 기능 사용 시 이메일 등록 요구

### 9.5 공휴일

* API 동기화 및 대체공휴일 표시 검증
* 캘린더 UI에서 공휴일 표시/숨김 설정 확인

---

## 10. 추가 고려사항

### 10.1 보안 측면

* 카카오 토큰 검증 로직 강화 필요
* 동의 변경 이력 로깅 고려
* 계정 연동 해제 기능 필요
* 비밀번호 정책 수립 (최소 길이, 복잡도)

### 10.2 UX 측면

* 온보딩 페이지에서 선택 동의의 혜택 명확히 설명
* 마이페이지에서 동의 변경 시 영향도 안내
* 로딩 상태 및 에러 상태 처리
* 온보딩 진행률 표시

### 12.3 성능 측면

* 공휴일 데이터 캐싱 전략
* DB 인덱스 최적화
* API 응답 시간 모니터링
