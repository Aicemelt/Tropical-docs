# 회원가입-로그인-캘린더 시스템 설계 문서

본 문서는 회원가입/로그인, 약관 동의 관리 및 캘린더 기능을 정리하여 **개발, QA, 기획** 등 팀 전체가 동일한 기준을 공유할 수 있도록 작성되었다.

**작성자:** 왕택준

**문서 버전:** v0.7

**최종 수정일:** 2025.09.11

**대상 독자:**

* 백엔드 개발자: DB 스키마, API 구현
* 프론트엔드 개발자: 화면 설계 및 연동
* QA: 검증 및 시나리오 테스트
* 기획/PM: 서비스 플로우 확인

---

## 1. 회원 관리 (User)

### 1.1 계정 모델 개요

* **식별자 분리**
  * 내부 PK: `user.id`
  * 로컬 로그인: `email` = 로그인 ID
  * 소셜 로그인: `(provider, provider_user_id)`
* **계정 타입 구분**
  * `account_type`: 로컬/소셜 계정 구분
  * 로컬 계정: `account_type='LOCAL'`, `password_hash` 존재
  * 소셜 계정: `account_type='SOCIAL'`, `password_hash` NULL, `social_account` 테이블 연결
* **소셜 제공자 구분**
  * `social_account.provider`: 구글/카카오/네이버 구분
  * 한 사용자가 여러 소셜 제공자 사용 시 각각 별도 계정으로 처리
* **이메일 정책**
  * **모든 계정 타입에서 이메일 필수**
  * **동일 이메일로 여러 소셜 계정 생성 허용** (일반적인 사용자 시나리오 지원)
  * 로컬 계정: 이메일 인증 필수
  * 소셜 계정: 소셜 플랫폼에서 이미 검증된 이메일 사용

### 1.2 회원가입 (로컬)

* **입력 항목**
  * 이메일 (로그인 ID, 인증 필수)
  * 비밀번호 (영문 대/소문자, 숫자, 특수문자 포함 10자 이상)
  * 닉네임 (필수)
* **처리 순서**
  1. 사용자 정보 입력
  2. 이메일 인증 토큰 JWT 생성 및 발송
  3. 사용자가 이메일에서 인증 링크 클릭
  4. JWT 토큰 검증 완료 후 계정 생성
  5. 자동 로그인 → **온보딩 페이지로 리다이렉트**

**비밀번호 정책:**
* 최소 10자 이상
* 영문 대/소문자, 숫자, 특수문자 조합 필수
* 연속 실패 5회 시 10분 잠금
* Argon2id 또는 BCrypt(≥12) 사용 권장

### 1.3 로그인 (로컬)

* **인증:** 이메일 + 비밀번호
* **처리:**
  * 이메일로 사용자 조회 (`status='ACTIVE'` 확인)
  * 비밀번호 해시 검증
  * 성공 시 `last_login_at` 갱신
  * Access/Refresh 토큰 발급 (HttpOnly + Secure 쿠키)
  * **온보딩 미완료 시 온보딩 페이지로 리다이렉트**

### 1.4 소셜 로그인 (카카오, 구글, 네이버)

* **지원 소셜 로그인:** 카카오, 구글, 네이버
* **각 제공자별 수집 정보:**
  * 카카오: `id`, `nickname`, `email`
  * 구글: `sub`, `name`, `email`
  * 네이버: `id`, `nickname`, `email`

* **플로우:**
  1. 소셜 OAuth 인증 완료 후 콜백
  2. `(provider, provider_user_id)`로 `social_account` 조회
  3. **기존 소셜 계정 연결이 없으면 신규 계정 생성**
  4. 신규 계정 생성:
     - 고유 식별자: `provider_user_id`
     - 닉네임: 소셜에서 제공받은 값 (중복 시 자동 suffix 추가)
     - 이메일: 소셜에서 제공받은 이메일 (검증 완료 상태로 설정)
  5. **온보딩 페이지로 리다이렉트** → 필수/선택 동의 수집
  6. 온보딩 완료 후 홈 진입

* **동일 이메일 처리 (허용):**
  * **일반적인 사용자 시나리오 지원:**
    ```
    예시: abc@gmail.com 이메일 사용자
    1. 구글 로그인 → 계정A 생성
    2. 카카오 로그인 (카카오에 등록된 이메일: abc@gmail.com) → 계정B 생성
    3. 네이버 로그인 (네이버에 등록된 이메일: abc@gmail.com) → 계정C 생성

    결과: 동일 이메일로 3개의 독립적인 계정 생성
    ```
  * **각 소셜 계정은 독립적인 사용자로 관리**
  * **이메일 중복 검사 없음 (사용자 편의성 우선)**

* **닉네임 중복 처리:**
```javascript
const socialNickname = "홍길동";
let finalNickname = socialNickname;
let suffix = 1;

while (await isNicknameExists(finalNickname)) {
  finalNickname = `${socialNickname}${suffix}`;
  suffix++;
}
```

### 1.5 온보딩 페이지

* **대상:** 로컬/소셜 모든 신규 사용자
* **UI 구성:**
  * **필수 동의 (라디오 버튼 + 약관 보기 링크):**
    * 서비스 이용약관 [약관 보기]
      * ○ 동의 ○ 동의하지 않음
    * 일정 기반 추천 동의 (캘린더 앱 핵심 기능 + AI 스몰 토크 기본) [약관 보기]
      * ○ 동의 ○ 동의하지 않음
  * **선택 동의 (라디오 버튼 + 약관 보기 링크):**
    * 일기 기반 추천 동의 (AI 추가 개인화) [약관 보기]
      * ○ 동의 ○ 동의하지 않음
    * 할일 기반 추천 동의 (AI 추가 개인화) [약관 보기]
      * ○ 동의 ○ 동의하지 않음
    * 버킷리스트 기반 추천 동의 (AI 추가 개인화) [약관 보기]
      * ○ 동의 ○ 동의하지 않음
* **약관 보기 기능:**
  * 각 [약관 보기] 클릭 시 해당 약관 내용 모달 또는 페이지 표시
  * 약관 내용 확인 후 닫기 가능
* **처리:**
  * **필수 동의 2개 모두 "동의"로 선택해야 완료 가능**
  * 완료 시 `onboarding_completed=1`
  * `user_consent` 테이블에 동의한 항목들 저장
  * 선택 동의는 이후 마이페이지에서 수정 가능

### 1.6 사용자 설정

* **캘린더 설정:**
  * `week_start`: 주 시작 요일 (기본 MON)
  * `timezone`: 기본 `Asia/Seoul`
  * `show_holidays`: 공휴일 표시 여부 (기본 표시)

* **알림 설정:**
  * **AI 스몰 토크 추천 알림:**
    * `smalltalk_notification_enabled`: 활성화 여부 (기본 활성화)
    * `smalltalk_notification_time`: 알림 시간 (기본 08:00)
    * `smalltalk_notification_days`: 알림 요일 (기본 daily)
  * **일정 시작 전 알림:**
    * `schedule_notification_enabled`: 활성화 여부 (기본 활성화)
    * `schedule_notification_minutes`: 시작 전 알림 시간 (기본 30분)
  * **투두 리스트 마감 알림:**
    * `todo_notification_enabled`: 활성화 여부 (기본 활성화)
    * `todo_notification_time`: 알림 시간 (기본 08:00)
    * `todo_notification_days_before`: 마감 며칠 전 알림 (기본 1일)

---

## 2. 동의 관리

### 2.1 동의 항목

* **필수 동의 (서비스 이용 최소 요구사항):**
  * `TERMS_OF_SERVICE` – 서비스 이용약관
  * `CALENDAR_PERSONALIZATION` – 일정 기반 추천 (캘린더 앱 + AI 스몰 토크 기본)

* **선택 동의 (AI 추가 개인화):**
  * `DIARY_PERSONALIZATION` – 일기 기반 추천
  * `TODO_PERSONALIZATION` – 할일 기반 추천
  * `BUCKET_PERSONALIZATION` – 버킷리스트 기반 추천

### 2.2 AI 추천 시스템 연동

* **기본 AI 스몰 토크:** 일정 데이터 기반 (필수 동의로 확보)
* **개인화 AI 추천:** 선택 동의 항목별 데이터 추가 활용
  * 일기 동의 on → 감정/기분 기반 추천 추가
  * 할일 동의 on → 업무 패턴 기반 추천 추가
  * 버킷리스트 동의 on → 취미/관심사 기반 추천 추가

### 2.3 수정/업데이트

* **마이페이지에서 수정 가능:**
  * 선택 동의 on/off 토글
  * 필수 동의는 해제 불가 (표시만)
* **선택 동의 off 시:**
  * 신규 데이터 수집 중지
  * 해당 기능 접근 시 403 + "동의 필요" → 동의 모달 표시
  * AI 추천에서 해당 데이터 소스 제외

### 2.4 온보딩 상태 체크

* 홈 진입 시 `onboarding_completed` 확인
* 미완료 시 온보딩 페이지로 강제 리다이렉트
* 완료된 사용자는 정상 서비스 이용

---

## 3. 캘린더 — 공휴일 연동 (Holiday)

### 3.1 데이터 수집

* **소스:** 한국천문연구원 특일 정보 API
* **주기:** 연 1회 + 필요시 재수집
* **동기화:** `external_id` 기준 UPSERT

### 3.2 저장 스키마

* **컬럼:** `country_code`, `start_date`, `end_date`, `name_ko`, `is_substitute`, `year`
* **제약:** `(country_code, start_date, end_date, name_ko)` 유니크

### 3.3 UI 전달

```json
{
  "id": "h-2025-10-03",
  "title": "개천절",
  "start": "2025-10-03",
  "end": "2025-10-03",
  "allDay": true,
  "type": "HOLIDAY",
  "isSubstitute": false
}
```

---

## 4. 마이페이지 (사용자 관리)

### 4.1 프로필

* **표시 정보:**
  * **이메일:** 읽기 전용 (로컬: 로그인 ID, 소셜: 제공받은 이메일)
  * **닉네임:** 수정 가능
  * **계정 타입:** 읽기 전용 (로컬 계정: "이메일로 가입", 소셜 계정: "구글로 가입" 등)
  * **주 시작 요일:** 수정 가능 (월요일/일요일)
  * **시간대 설정:** 수정 가능 (기본 Asia/Seoul)
  * **공휴일 표시 여부:** 수정 가능 (표시/숨김)
  * **알림 설정:** 수정 가능 (각종 알림 시간 및 활성화 설정)

* **수정 가능한 항목:**
  * 닉네임 - 텍스트 입력
  * 주 시작 요일 - 드롭다운 (월요일/일요일)
  * 시간대 설정 - 드롭다운 (Asia/Seoul 등)
  * 공휴일 표시 여부 - 토글 스위치 (표시/숨김)
  * **알림 설정:**
    * AI 스몰 토크 추천 알림 - 토글 + 시간 선택 + 요일 선택
    * 일정 시작 전 알림 - 토글 + 시간 간격 선택 (5분/10분/15분/30분/1시간/2시간/하루 전)
    * 투두 리스트 마감 알림 - 토글 + 시간 선택 + 며칠 전 선택

### 4.2 동의 관리

* **현재 동의 상태 조회**
* **UI 구성:**
  * **필수 동의**: 비활성화된 토글 + [약관 보기] 링크
    * 🔒 서비스 이용약관 동의 (수정 불가) [약관 보기]
    * 🔒 일정 기반 추천 동의 (수정 불가) [약관 보기]
  * **선택 동의**: 활성화된 토글 스위치 + [약관 보기] 링크
    * 🔘 일기 기반 추천 동의 [약관 보기]
    * 🔘 할일 기반 추천 동의 [약관 보기]
    * 🔘 버킷리스트 기반 추천 동의 [약관 보기]
* **약관 보기 기능:**
  * 각 [약관 보기] 클릭 시 해당 약관 내용 모달 표시
  * 약관 버전 정보 및 마지막 업데이트 날짜 표시
* **동의 변경 시:**
  * AI 추천 영향도 안내 표시 (예: "일기 기반 추천을 끄면 감정 분석 기반 추천이 제공되지 않습니다")
  * `user_consent` 테이블 업데이트

### 4.3 회원 탈퇴 (논리적 삭제)

* **물리적 삭제 대신 논리적 삭제 방식 사용**
* **탈퇴 처리:**
  * `status='DELETED'`로 변경
  * 이메일 마스킹: `deleted_{user_id}_{timestamp}@deleted.com`
  * 닉네임 마스킹: `탈퇴회원_{user_id}`
* **재가입 허용:** 이메일 마스킹으로 동일 이메일 재가입 가능
* **접근 차단:** 탈퇴 회원의 모든 서비스 이용 차단

---

## 5. API 명세

### 5.1 Auth (로컬)

* `POST /api/auth/signup` - 이메일, 비밀번호, 닉네임
* `POST /api/auth/login`
* `POST /api/auth/logout`
* `POST /api/auth/token/refresh`
* `POST /api/auth/email/send-verification` - 이메일 인증 토큰 발송 (JWT)
* `GET /api/auth/email/verify?token=...` - 이메일 인증 토큰 검증 (JWT)

**이메일 인증 처리 (JWT 방식):**
```javascript
// 토큰 생성
const verificationToken = jwt.sign(
  {
    email,
    purpose: 'email_verify',
    exp: Math.floor(Date.now() / 1000) + (30 * 60) // 30분
  },
  SECRET_KEY
);

// 인증 링크: /verify-email?token=eyJ...
// 검증 시 JWT 디코딩으로 stateless 처리
```

### 5.2 Auth (소셜 로그인)

**카카오 로그인**
* `GET /oauth2/authorization/kakao` – 카카오 로그인 시작
* `GET /login/oauth2/code/kakao` – 카카오 콜백

**구글 로그인**
* `GET /oauth2/authorization/google` – 구글 로그인 시작
* `GET /login/oauth2/code/google` – 구글 콜백

**네이버 로그인**
* `GET /oauth2/authorization/naver` – 네이버 로그인 시작
* `GET /login/oauth2/code/naver` – 네이버 콜백

### 5.3 온보딩

* `GET /api/me/onboarding-status` - 온보딩 상태 확인
```json
{
  "onboardingCompleted": false,
  "requiredConsents": ["TERMS_OF_SERVICE", "CALENDAR_PERSONALIZATION"]
}
```

* `POST /api/auth/onboarding` - 온보딩 완료
```json
{
  "requiredConsents": {
    "TERMS_OF_SERVICE": true,
    "CALENDAR_PERSONALIZATION": true
  },
  "optionalConsents": {
    "DIARY_PERSONALIZATION": false,
    "TODO_PERSONALIZATION": true,
    "BUCKET_PERSONALIZATION": false
  }
}
```

### 5.4 Profile & Consent

* `GET /api/me/profile` - 프로필 조회
```json
{
  "email": "user@example.com",
  "nickname": "홍길동",
  "accountType": "SOCIAL",
  "provider": "GOOGLE",
  "weekStart": "MON",
  "timezone": "Asia/Seoul",
  "showHolidays": true,
  "notifications": {
    "smalltalk": {
      "enabled": true,
      "time": "08:00",
      "days": "daily"
    },
    "schedule": {
      "enabled": true,
      "minutesBefore": 30
    },
    "todo": {
      "enabled": true,
      "time": "08:00",
      "daysBefore": 1
    }
  }
}
```

* `PATCH /api/me/profile` - 프로필 수정
```json
{
  "nickname": "새닉네임",
  "weekStart": "SUN",
  "timezone": "Asia/Seoul",
  "showHolidays": false,
  "notifications": {
    "smalltalk": {
      "enabled": false,
      "time": "09:00",
      "days": "weekdays"
    },
    "schedule": {
      "enabled": true,
      "minutesBefore": 60
    },
    "todo": {
      "enabled": true,
      "time": "07:00",
      "daysBefore": 2
    }
  }
}
```

* `GET /api/me/consents` - 동의 현황 조회
```json
{
  "requiredConsents": {
    "TERMS_OF_SERVICE": { "agreed": true, "agreedAt": "2025-01-01T00:00:00Z" },
    "CALENDAR_PERSONALIZATION": { "agreed": true, "agreedAt": "2025-01-01T00:00:00Z" }
  },
  "optionalConsents": {
    "DIARY_PERSONALIZATION": { "agreed": false, "agreedAt": null },
    "TODO_PERSONALIZATION": { "agreed": true, "agreedAt": "2025-01-01T00:00:00Z" },
    "BUCKET_PERSONALIZATION": { "agreed": false, "agreedAt": null }
  }
}
```

* `PATCH /api/me/consents` - 선택 동의 수정
```json
{
  "DIARY_PERSONALIZATION": true,
  "TODO_PERSONALIZATION": false,
  "BUCKET_PERSONALIZATION": true
}
```

* `DELETE /api/me/account` - 회원 탈퇴 (논리적 삭제)

### 5.5 Terms & Conditions

* `GET /api/terms/service` - 서비스 이용약관 조회
* `GET /api/terms/privacy` - 개인정보처리방침 조회
* `GET /api/terms/calendar-personalization` - 일정 기반 추천 약관 조회
* `GET /api/terms/diary-personalization` - 일기 기반 추천 약관 조회
* `GET /api/terms/todo-personalization` - 할일 기반 추천 약관 조회
* `GET /api/terms/bucket-personalization` - 버킷리스트 기반 추천 약관 조회

```json
// 약관 조회 응답 예시
{
  "type": "TERMS_OF_SERVICE",
  "version": "v1.0",
  "title": "서비스 이용약관",
  "content": "제1조 (목적) 이 약관은...",
  "lastUpdated": "2025-01-01T00:00:00Z",
  "effectiveDate": "2025-01-01T00:00:00Z"
}
```

### 5.6 Calendar

* `GET /api/calendar`
* `GET /api/calendar/holidays`

---

## 6. DB 스키마

### 6.1 user 테이블 (사용자 기본 정보)

```sql
CREATE TABLE user (
  -- 식별자 및 인증 관련
  id BIGINT PRIMARY KEY AUTO_INCREMENT,                    -- 사용자 고유 번호
  email VARCHAR(255) NOT NULL,                             -- 이메일 주소 (모든 계정 타입에서 필수)
  password_hash VARCHAR(255) NULL,                         -- 암호화된 비밀번호 (로컬 계정만 사용)
  email_verified TINYINT(1) NOT NULL DEFAULT 0,           -- 이메일 인증 완료 여부
  account_type ENUM('LOCAL','SOCIAL') NOT NULL,           -- 계정 타입 (로컬/소셜)

  -- 사용자 프로필 정보
  nickname VARCHAR(50) NOT NULL,                           -- 사용자 닉네임 (필수)

  -- 회원가입 진행 상태
  onboarding_completed TINYINT(1) NOT NULL DEFAULT 0,     -- 온보딩 완료 여부

  -- 시스템 관리용 정보
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, -- 계정 생성 시간
  last_login_at DATETIME NULL,                            -- 마지막 로그인 시간
  status ENUM('ACTIVE','BLOCKED','DELETED') NOT NULL DEFAULT 'ACTIVE', -- 계정 상태

  -- 캘린더 표시 개인 설정
  week_start ENUM('SUN','MON') NOT NULL DEFAULT 'MON',    -- 주 시작 요일
  timezone VARCHAR(50) NOT NULL DEFAULT 'Asia/Seoul',     -- 시간대 설정
  show_holidays TINYINT(1) NOT NULL DEFAULT 1,           -- 공휴일 표시 여부

  -- 알림 설정
  smalltalk_notification_enabled TINYINT(1) NOT NULL DEFAULT 1,     -- 스몰 토크 알림 활성화
  smalltalk_notification_time TIME NOT NULL DEFAULT '08:00:00',     -- 스몰 토크 알림 시간
  smalltalk_notification_days VARCHAR(20) NOT NULL DEFAULT 'daily', -- daily/weekdays/weekends/custom

  schedule_notification_enabled TINYINT(1) NOT NULL DEFAULT 1,      -- 일정 알림 활성화
  schedule_notification_minutes INT NOT NULL DEFAULT 30,            -- 일정 시작 전 알림 (분)

  todo_notification_enabled TINYINT(1) NOT NULL DEFAULT 1,          -- 투두 마감 알림 활성화
  todo_notification_time TIME NOT NULL DEFAULT '08:00:00',          -- 투두 마감 알림 시간
  todo_notification_days_before INT NOT NULL DEFAULT 1,             -- 마감 며칠 전 알림

  -- 데이터 무결성 제약
  UNIQUE KEY uq_user_nickname (nickname)                  -- 닉네임 중복 방지
);
```

### 6.2 social_account 테이블 (소셜 로그인 연동 정보)

```sql
CREATE TABLE social_account (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,                   -- 소셜 연동 정보 고유 번호
  user_id BIGINT NOT NULL,                                -- 연결된 사용자 번호
  provider ENUM('KAKAO','GOOGLE','NAVER') NOT NULL,      -- 소셜 로그인 제공자
  provider_user_id VARCHAR(255) NOT NULL,                -- 소셜 제공자의 사용자 고유 ID
  linked_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, -- 소셜 계정 연결 시간

  UNIQUE KEY uq_social (provider, provider_user_id),     -- 동일 소셜 계정 중복 연결 방지
  CONSTRAINT fk_social_user FOREIGN KEY (user_id) REFERENCES user(id)
);
```

### 6.3 user_consent 테이블 (사용자 동의 관리)

```sql
CREATE TABLE user_consent (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,                   -- 동의 정보 고유 번호
  user_id BIGINT NOT NULL,                                -- 대상 사용자 번호
  consent_type ENUM(
    'TERMS_OF_SERVICE',           -- 서비스 이용약관 (필수)
    'CALENDAR_PERSONALIZATION',   -- 일정 기반 추천 (필수) - 캘린더 앱 + AI 기본
    'DIARY_PERSONALIZATION',      -- 일기 기반 추천 (선택) - AI 추가 개인화
    'TODO_PERSONALIZATION',       -- 할일 기반 추천 (선택) - AI 추가 개인화
    'BUCKET_PERSONALIZATION'      -- 버킷 기반 추천 (선택) - AI 추가 개인화
  ) NOT NULL,
  agreed TINYINT(1) NOT NULL,                             -- 동의 여부 (0:미동의, 1:동의)
  agreed_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, -- 동의 처리 시간

  UNIQUE KEY uq_user_consent (user_id, consent_type),    -- 사용자별 동의 항목 유니크
  CONSTRAINT fk_consent_user FOREIGN KEY (user_id) REFERENCES user(id)
);
```

### 6.4 계정 타입별 조회 예시

```sql
-- 완전한 계정 정보 조회 (계정 타입 + 소셜 제공자 구분)
SELECT
    u.id,
    u.email,
    u.nickname,
    u.account_type,
    sa.provider,
    u.last_login_at
FROM user u
LEFT JOIN social_account sa ON u.id = sa.user_id
WHERE u.email = 'abc@gmail.com'
ORDER BY u.last_login_at DESC;

-- 결과 예시:
-- user_id | email           | nickname  | account_type | provider | last_login_at
-- 3       | abc@gmail.com   | 홍길동    | SOCIAL       | GOOGLE   | 2025-01-15 10:30:00
-- 1       | abc@gmail.com   | 홍길동1   | SOCIAL       | KAKAO    | 2025-01-10 08:00:00
-- 2       | abc@gmail.com   | 홍길동2   | LOCAL        | NULL     | 2025-01-05 15:20:00
```

### 6.5 holiday 테이블 (공휴일 정보)

```sql
CREATE TABLE holiday (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,                   -- 공휴일 정보 고유 번호
  country_code CHAR(2) NOT NULL DEFAULT 'KR',            -- 국가 코드
  start_date DATE NOT NULL,                               -- 공휴일 시작 날짜
  end_date DATE NOT NULL,                                 -- 공휴일 종료 날짜 (연휴 처리용)
  name_ko VARCHAR(100) NOT NULL,                         -- 공휴일 이름 (한국어)
  is_substitute TINYINT(1) NOT NULL DEFAULT 0,           -- 대체공휴일 여부
  year SMALLINT NOT NULL,                                 -- 연도 (검색 성능 최적화용)

  UNIQUE KEY uq_holiday (country_code, start_date, end_date, name_ko), -- 동일 공휴일 중복 방지
  KEY idx_holiday_year (country_code, year, start_date)   -- 연도별 조회 성능 최적화
);
```

---

## 7. 에러 코드

### 7.1 인증 관련
* `AUTH-001` 잘못된 자격증명
* `AUTH-002` 차단/삭제 계정
* `AUTH-101` 소셜 응답 검증 실패
* `AUTH-102` 소셜 계정 중복 연결 (동일한 소셜 계정으로 재가입 시도)
* `AUTH-201` 이메일 미검증
* `AUTH-202` 이메일 인증 토큰 무효
* `AUTH-203` 이메일 인증 토큰 만료
* `AUTH-301` 온보딩 미완료
* `AUTH-302` 필수 동의 누락

### 7.2 사용자 관련
* `USER-001` 닉네임 중복
* `USER-004` 탈퇴된 계정

### 7.3 캘린더 관련
* `CAL-001` 잘못된 기간 파라미터
* `CAL-101` 공휴일 동기화 실패

---

## 8. 권장 구현 순서

1. **1단계**: 로컬 회원가입/로그인 구현 (JWT 이메일 인증 포함)
2. **2단계**: 온보딩 페이지 구현 (필수/선택 동의 분리)
3. **3단계**: 소셜 로그인 구현 (카카오, 구글, 네이버) - 동일 이메일 허용
4. **4단계**: 마이페이지 프로필/동의 관리 구현
5. **5단계**: 회원 탈퇴 기능 구현 (논리적 삭제)
6. **6단계**: 공휴일 API 연동

---

## 9. QA 체크리스트

### 9.1 회원가입/로그인
* **로컬 회원가입**: JWT 이메일 인증 → 계정 생성 → 온보딩
* **소셜 로그인**: OAuth 성공 → 계정 생성 (이메일 중복 허용) → 온보딩
* **동일 이메일 다중 소셜 계정**: 구글/카카오/네이버에서 동일 이메일 사용 시 각각 별도 계정 생성 확인
* 닉네임 중복 시 자동 suffix 추가 확인
* 비밀번호 정책 검증: 10자 이상, 영문/숫자/특수문자 조합

### 9.2 이메일 인증 (JWT 방식)
* **JWT 토큰 생성**: 30분 만료 시간 설정
* **토큰 검증**: JWT 디코딩 및 만료 시간 확인
* **Stateless 처리**: 별도 DB 저장 없이 JWT로 처리

### 9.3 온보딩
* **필수 동의 2개 체크 확인**: TERMS_OF_SERVICE, CALENDAR_PERSONALIZATION
* 필수 동의 미체크 시 완료 불가
* 온보딩 미완료 시 홈 접근 차단
* **동의 정보 저장**: `user_consent` 테이블에 동의한 항목들 저장
* **약관 보기 기능**: 각 동의 항목의 [약관 보기] 링크 클릭 시 해당 약관 모달 표시 확인
* **라디오 버튼 UI**: 모든 동의 항목을 "동의/동의하지 않음" 라디오 버튼으로 표시

### 9.4 마이페이지
* **프로필 표시**: 이메일(읽기 전용), 닉네임, 계정 타입, 소셜 제공자, 주 시작 요일, 시간대, 공휴일 표시 여부, 알림 설정 확인
* **프로필 수정**: 닉네임, 주 시작 요일, 시간대, 공휴일 표시 여부, 알림 설정 수정 가능 확인
* **계정 타입 표시**:
  * 로컬 계정: "이메일로 가입" 표시
  * 소셜 계정: "구글로 가입", "카카오로 가입", "네이버로 가입" 표시
* **알림 설정 테스트**:
  * AI 스몰 토크 알림: 토글 on/off + 시간 선택 + 요일 선택 (daily/weekdays/weekends)
  * 일정 시작 전 알림: 토글 on/off + 시간 간격 선택 (5분~하루 전)
  * 투두 마감 알림: 토글 on/off + 시간 선택 + 며칠 전 선택
* **필수 동의 표시**: 비활성화된 토글 + [약관 보기] 링크
* **선택 동의 토글**: 3개 선택 동의 항목 on/off 가능
* **동의 변경 시**: `user_consent` 테이블 업데이트 확인
* **약관 보기 기능**: 각 동의 항목별 약관 내용 모달 표시 확인

### 9.5 AI 추천 연동
* **기본 추천**: 일정 기반 AI 스몰 토크 (필수 동의로 확보)
* **추가 개인화**: 선택 동의별 추가 데이터 활용 확인
* **동의 off 시**: 해당 데이터 소스 AI 추천에서 제외

### 9.6 회원 탈퇴
* 논리적 삭제 처리 확인
* 탈퇴 후 모든 서비스 접근 차단
* 개인정보 마스킹 처리 확인
* 동일 이메일 재가입 가능 확인

### 9.7 공휴일
* API 동기화 및 대체공휴일 표시 검증
* 캘린더 UI에서 공휴일 표시/숨김 설정 확인

### 9.8 동일 이메일 다중 계정 시나리오
* **테스트 시나리오**: abc@gmail.com으로 구글/카카오/네이버 각각 가입
* **예상 결과**: 3개의 독립적인 계정 생성 (각각 다른 user_id)
* **데이터 검증**: `social_account` 테이블에 3개 레코드 생성 확인
* **로그인 테스트**: 각 소셜 로그인으로 해당 계정에만 접근 확인

---

## 10. 추가 고려사항

### 10.1 보안 측면
* **비밀번호 정책 강화**:
  * 길이/구성: 최소 10자, 영문 대/소문자+숫자+특수문자 조합
  * 해시: Argon2id(권장, 메모리 코스트 충분) 또는 BCrypt ≥ 12
  * 락아웃: 5회 연속 실패 시 10분 잠금 (관리자 해제 가능)
  * 금지어/유출 리스트 차단: "password", "qwerty", 유출 사전 등
  * 변경 알림: 비밀번호 변경 시 보안 알림 메일 발송
* **토큰 보안**:
  * 이메일 인증 토큰 JWT 사용 (30분 만료)
  * 토큰 재사용 공격 방지를 위한 일회용 처리
* **소셜 로그인 토큰 검증 로직 강화**

### 10.2 UX 측면
* **온보딩 페이지 UX**:
  * 필수/선택 동의 구분을 시각적으로 명확히 표시
  * 각 동의 항목의 혜택과 영향도 명확히 설명
  * 약관 내용을 쉽게 확인할 수 있는 모달/페이지 제공
* **마이페이지 UX**:
  * 동의 변경 시 AI 추천에 미치는 영향 안내
  * 토글 스위치로 직관적인 on/off 조작
  * **알림 설정 UX**: 시간 선택기, 요일 선택, 간격 선택 등 직관적인 UI 제공
  * 로딩 상태 및 에러 상태 처리
* **알림 UX**:
  * 알림 설정 변경 시 즉시 반영 안내
  * 알림 미리보기 기능 (설정한 시간에 어떤 알림이 올지 확인)
  * 알림 끄기/다시 켜기 쉬운 접근성
* **동일 이메일 다중 계정 안내**: 사용자가 여러 소셜 계정으로 가입했을 때 계정 구분 안내

### 10.3 성능 측면
* 공휴일 데이터 캐싱 전략
* DB 인덱스 최적화
* API 응답 시간 모니터링
* 이메일 발송 큐 시스템 도입
* 약관 내용 캐싱 (자주 조회되는 데이터)

### 10.4 운영 측면
* **계정 관리 복잡성**: 동일 이메일로 여러 계정 존재 시 고객지원 복잡도 증가
* **계정 찾기 기능 필요성**: 사용자가 어떤 방식으로 가입했는지 기억하지 못하는 경우 대응
  * 이메일 입력 시 해당 이메일로 가입된 모든 계정 표시 (로컬/소셜별)
  * 각 계정의 마지막 로그인 시간 및 로그인 방식 안내
  * 보안을 위한 닉네임 마스킹 처리 (홍** 형태)
* **계정 통합 요청 대응**: 사용자가 실수로 여러 계정 생성 시 통합 요청 처리 방안
* **모니터링**: 동일 이메일 계정 수 추적 및 이상 패턴 감지
* **약관 관리**: 약관 버전 관리 및 변경 시 사용자 재동의 프로세스

### 10.5 법적 준수
* **개인정보보호법 준수**: 동의 철회권 보장, 처리 목적 명시
* **GDPR 대비**: 데이터 이동권, 삭제권 등 고려
* **약관 투명성**: 각 동의 항목별 수집/이용 목적 명확히 고지

---

## 11. 결론

본 설계는 **4개 테이블**로 간소화하여 복잡성을 줄이고, **AI 추천 시스템**과의 연동을 고려한 동의 관리 체계를 구축했습니다.

**핵심 설계 원칙:**
1. **단순함**: 최소 필요 테이블로 구성
2. **사용자 편의성**: 동일 이메일 다중 소셜 계정 허용
3. **AI 연동 최적화**: 필수/선택 동의 구분으로 추천 품질 향상
4. **확장성**: 향후 기능 확장을 위한 유연한 구조

**AI 추천 시스템 연동:**
- **기본 스몰 토크**: 일정 데이터 활용 (필수 동의)
- **개인화 추천**: 일기/할일/버킷리스트 데이터 추가 활용 (선택 동의)
- **동의 기반 데이터 제어**: 사용자 동의 범위에 따른 추천 개인화 수준 조절
